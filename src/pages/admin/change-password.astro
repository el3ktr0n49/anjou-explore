---
// Force SSR : Page prot√©g√©e qui acc√®de √† request.headers pour auth
export const prerender = false;

import Layout from '../../layouts/Layout.astro';

// V√©rifier si l'utilisateur est authentifi√©
const token = Astro.cookies.get('auth_token')?.value;
if (!token) {
  return Astro.redirect('/admin/login');
}
---

<Layout title="Changer mon mot de passe - Admin Anjou Explore">
  <div class="min-h-screen flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8"
       style="background: linear-gradient(135deg, #c4a571 0%, #6b7456 100%);">

    <div class="max-w-md w-full">
      <!-- Card principale -->
      <div class="bg-white rounded-2xl shadow-2xl overflow-hidden transform hover:scale-[1.02] transition-transform duration-300">

        <!-- Header avec gradient -->
        <div class="px-8 py-6 bg-gradient-to-r from-[#c4a571] to-[#6b7456]">
          <h2 class="text-3xl font-bold text-white text-center">
            Changer mon mot de passe
          </h2>
          <p class="text-center text-white/90 mt-2 text-sm">
            S√©curisez votre compte avec un nouveau mot de passe
          </p>
        </div>

        <!-- Formulaire -->
        <div class="px-8 py-6">

          <!-- Message d'alerte pour premier login -->
          <div id="first-login-alert" class="mb-6 p-4 bg-amber-50 border border-amber-200 rounded-lg hidden">
            <div class="flex items-start">
              <svg class="w-5 h-5 text-amber-600 mt-0.5 mr-3 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
              </svg>
              <div>
                <p class="text-sm font-semibold text-amber-800">
                  Changement de mot de passe obligatoire
                </p>
                <p class="text-sm text-amber-700 mt-1">
                  Vous devez changer votre mot de passe par d√©faut pour acc√©der au dashboard.
                </p>
              </div>
            </div>
          </div>

          <!-- Zone de messages -->
          <div id="message-area" class="mb-6"></div>

          <form id="change-password-form" class="space-y-5">

            <!-- Mot de passe actuel -->
            <div>
              <label for="currentPassword" class="block text-sm font-medium text-gray-700 mb-2">
                Mot de passe actuel
              </label>
              <input
                type="password"
                id="currentPassword"
                name="currentPassword"
                required
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#c4a571] focus:border-transparent transition-all duration-200 text-gray-900"
                placeholder="Entrez votre mot de passe actuel"
              />
            </div>

            <!-- Nouveau mot de passe -->
            <div>
              <label for="newPassword" class="block text-sm font-medium text-gray-700 mb-2">
                Nouveau mot de passe
              </label>
              <input
                type="password"
                id="newPassword"
                name="newPassword"
                required
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#c4a571] focus:border-transparent transition-all duration-200 text-gray-900"
                placeholder="Minimum 12 caract√®res"
              />
            </div>

            <!-- Confirmer nouveau mot de passe -->
            <div>
              <label for="confirmPassword" class="block text-sm font-medium text-gray-700 mb-2">
                Confirmer le nouveau mot de passe
              </label>
              <input
                type="password"
                id="confirmPassword"
                name="confirmPassword"
                required
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#c4a571] focus:border-transparent transition-all duration-200 text-gray-900"
                placeholder="Confirmez votre nouveau mot de passe"
              />
            </div>

            <!-- Exigences du mot de passe -->
            <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
              <p class="text-xs font-semibold text-gray-700 mb-2">
                Exigences du mot de passe :
              </p>
              <ul class="space-y-1 text-xs text-gray-600">
                <li class="flex items-center">
                  <span class="mr-2">‚Ä¢</span>
                  Au moins 12 caract√®res
                </li>
                <li class="flex items-center">
                  <span class="mr-2">‚Ä¢</span>
                  Au moins 1 majuscule (A-Z)
                </li>
                <li class="flex items-center">
                  <span class="mr-2">‚Ä¢</span>
                  Au moins 1 minuscule (a-z)
                </li>
                <li class="flex items-center">
                  <span class="mr-2">‚Ä¢</span>
                  Au moins 1 chiffre (0-9)
                </li>
                <li class="flex items-center">
                  <span class="mr-2">‚Ä¢</span>
                  Au moins 1 caract√®re sp√©cial (@$!%*?&)
                </li>
              </ul>
            </div>

            <!-- Bouton de soumission -->
            <button
              type="submit"
              id="submit-btn"
              class="w-full bg-gradient-to-r from-[#c4a571] to-[#6b7456] text-white py-3 px-4 rounded-lg font-semibold text-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-[#c4a571] focus:ring-offset-2"
            >
              Changer mon mot de passe
            </button>

            <!-- Lien retour dashboard (affich√© seulement si pas de changement forc√©) -->
            <a
              href="/admin/dashboard"
              id="back-link"
              class="block text-center text-sm text-gray-600 hover:text-[#c4a571] transition-colors duration-200 hidden"
            >
              ‚Üê Retour au dashboard
            </a>

          </form>
        </div>
      </div>

      <!-- Message de s√©curit√© -->
      <p class="text-center text-white/80 text-xs mt-6">
        üîí Vos donn√©es sont s√©curis√©es et chiffr√©es
      </p>
    </div>
  </div>

  <script src="../../scripts/admin/change-password.ts"></script>
</Layout>
