---
import Layout from '../../layouts/Layout.astro';
---

<Layout title="Connexion Administration" description="Accès sécurisé à l'espace d'administration">
  <!-- Section de connexion avec fond élégant -->
  <section class="min-h-[calc(100vh-400px)] py-10 md:py-12 bg-gradient-to-br from-[var(--color-anjou-beige)] via-white to-[var(--color-anjou-beige)]/50">
    <div class="container mx-auto px-4 flex items-center justify-center">
      <div class="w-full max-w-md">

        <!-- En-tête élégant -->
        <div class="text-center mb-10">
          <div class="inline-flex items-center justify-center w-16 h-16 bg-[var(--color-anjou-gold)]/10 rounded-full mb-4">
            <svg class="w-8 h-8 text-[var(--color-anjou-gold)]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
            </svg>
          </div>
          <h1 class="text-3xl md:text-4xl font-serif text-[var(--color-anjou-brown)] mb-3">
            Espace Privé
          </h1>
          <p class="text-[var(--color-anjou-olive)] text-sm">
            Accès réservé aux membres de l'équipe
          </p>
        </div>

        <!-- Carte de connexion -->
        <div class="bg-white rounded-2xl shadow-2xl overflow-hidden border border-[var(--color-anjou-beige)]">
          <div class="bg-gradient-to-r from-[var(--color-anjou-gold)] to-[var(--color-anjou-olive)] h-2"></div>

          <div class="p-8 md:p-10">
            <form id="login-form" class="space-y-6">

              <!-- Identifiant -->
              <div class="form-group">
                <label for="adminName" class="form-label">
                  Identifiant
                </label>
                <input
                  type="text"
                  id="adminName"
                  name="adminName"
                  required
                  autocomplete="username"
                  class="form-input"
                  placeholder="Votre identifiant"
                />
              </div>

              <!-- Mot de passe -->
              <div class="form-group">
                <label for="password" class="form-label">
                  Mot de passe
                </label>
                <input
                  type="password"
                  id="password"
                  name="password"
                  required
                  autocomplete="current-password"
                  class="form-input"
                  placeholder="••••••••"
                />
              </div>

              <!-- Code de vérification -->
              <div class="form-group">
                <label for="token2FA" class="form-label">
                  Code de vérification
                </label>
                <input
                  type="text"
                  id="token2FA"
                  name="token2FA"
                  required
                  inputmode="numeric"
                  maxlength="6"
                  autocomplete="one-time-code"
                  class="form-input text-center text-2xl tracking-[0.5em] font-mono"
                  placeholder="000000"
                />
                <p class="form-hint">
                  Code à 6 chiffres de votre application d'authentification
                </p>
              </div>

              <!-- Message d'erreur -->
              <div id="error-message" class="hidden error-message">
                <div class="flex items-start space-x-3">
                  <svg class="w-5 h-5 text-red-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                  <p class="text-sm text-red-800"></p>
                </div>
              </div>

              <!-- Bouton de connexion -->
              <button
                type="submit"
                id="submit-btn"
                class="submit-button"
              >
                <span class="button-text">Connexion sécurisée</span>
                <svg class="button-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path>
                </svg>
              </button>
            </form>
          </div>

          <!-- Footer de la carte -->
          <div class="px-8 md:px-10 py-6 bg-gradient-to-r from-[var(--color-anjou-beige)]/30 to-[var(--color-anjou-beige)]/10 border-t border-[var(--color-anjou-beige)]">
            <div class="flex items-center justify-center space-x-2 text-xs text-[var(--color-anjou-olive)]">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
              </svg>
              <span>Connexion chiffrée et sécurisée</span>
            </div>
          </div>
        </div>

      </div>
    </div>
  </section>
</Layout>

<style>
  /* Formulaire élégant cohérent avec la charte Anjou Explore */
  .form-group {
    position: relative;
  }

  .form-label {
    display: block;
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--color-anjou-brown);
    margin-bottom: 0.5rem;
    transition: color 0.2s;
  }

  .form-input {
    width: 100%;
    padding: 0.875rem 1rem;
    border: 2px solid #e5e7eb;
    border-radius: 0.75rem;
    font-size: 0.9375rem;
    color: var(--color-anjou-brown);
    background: white;
    transition: all 0.2s ease;
  }

  .form-input::placeholder {
    color: #9ca3af;
  }

  .form-input:hover {
    border-color: var(--color-anjou-beige);
  }

  .form-input:focus {
    outline: none;
    border-color: var(--color-anjou-gold);
    box-shadow: 0 0 0 4px rgba(196, 165, 113, 0.1);
  }

  .form-hint {
    margin-top: 0.5rem;
    font-size: 0.75rem;
    color: var(--color-anjou-olive);
  }

  .error-message {
    padding: 1rem;
    background: linear-gradient(to right, #fef2f2, #fee2e2);
    border: 1px solid #fecaca;
    border-radius: 0.75rem;
  }

  .submit-button {
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 1rem 1.5rem;
    background: linear-gradient(135deg, var(--color-anjou-gold) 0%, var(--color-anjou-olive) 100%);
    color: white;
    font-weight: 600;
    font-size: 0.9375rem;
    border: none;
    border-radius: 0.75rem;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 12px rgba(196, 165, 113, 0.3);
  }

  .submit-button:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(196, 165, 113, 0.4);
  }

  .submit-button:active:not(:disabled) {
    transform: translateY(0);
  }

  .submit-button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .button-icon {
    width: 1.25rem;
    height: 1.25rem;
    transition: transform 0.3s ease;
  }

  .submit-button:hover:not(:disabled) .button-icon {
    transform: translateX(4px);
  }

  /* Animation d'apparition */
  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .form-group {
    animation: fadeInUp 0.4s ease backwards;
  }

  .form-group:nth-child(1) {
    animation-delay: 0.1s;
  }

  .form-group:nth-child(2) {
    animation-delay: 0.2s;
  }

  .form-group:nth-child(3) {
    animation-delay: 0.3s;
  }

  .submit-button {
    animation: fadeInUp 0.4s ease backwards;
    animation-delay: 0.4s;
  }
</style>

<script>
  const form = document.getElementById('login-form') as HTMLFormElement;
  const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
  const buttonText = submitBtn?.querySelector('.button-text') as HTMLSpanElement;
  const errorMessage = document.getElementById('error-message') as HTMLDivElement;

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();

    // Désactiver le bouton et changer le texte
    submitBtn.disabled = true;
    if (buttonText) buttonText.textContent = 'Connexion en cours...';

    // Cacher les erreurs précédentes
    errorMessage.classList.add('hidden');

    // Récupérer les données
    const formData = new FormData(form);
    const data = {
      adminName: formData.get('adminName') as string,
      password: formData.get('password') as string,
      token2FA: formData.get('token2FA') as string,
    };

    // Validation du format 2FA avant envoi
    if (!/^\d{6}$/.test(data.token2FA)) {
      showError('Le code de vérification doit contenir exactement 6 chiffres');
      submitBtn.disabled = false;
      if (buttonText) buttonText.textContent = 'Connexion sécurisée';
      return;
    }

    try {
      // Appel API
      const response = await fetch('/api/auth/login', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(data),
      });

      const result = await response.json();

      if (response.ok && result.success) {
        // Succès → Afficher message de succès puis rediriger
        if (buttonText) buttonText.textContent = 'Connexion réussie !';
        setTimeout(() => {
          window.location.href = '/admin/dashboard';
        }, 500);
      } else {
        // Erreur → Afficher message
        showError(result.error || 'Identifiants ou code invalides');
        submitBtn.disabled = false;
        if (buttonText) buttonText.textContent = 'Connexion sécurisée';
      }
    } catch (error) {
      showError('Erreur réseau. Veuillez réessayer.');
      submitBtn.disabled = false;
      if (buttonText) buttonText.textContent = 'Connexion sécurisée';
    }
  });

  function showError(message: string) {
    errorMessage.classList.remove('hidden');
    const p = errorMessage.querySelector('p');
    if (p) p.textContent = message;
  }

  // Auto-focus sur le premier champ
  const adminNameInput = document.getElementById('adminName') as HTMLInputElement;
  adminNameInput?.focus();

  // Format automatique du code 2FA (enlever espaces et caractères non-numériques)
  const token2FAInput = document.getElementById('token2FA') as HTMLInputElement;
  token2FAInput?.addEventListener('input', (e) => {
    const target = e.target as HTMLInputElement;
    target.value = target.value.replace(/\D/g, '').slice(0, 6);
  });
</script>
