// Prisma Schema pour Anjou Explore
// Documentation: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ═══════════════════════════════════════════════════════════
// ADMINISTRATEURS (pour l'authentification 2FA)
// ═══════════════════════════════════════════════════════════

model Admin {
  id                 String    @id @default(uuid())
  name               String    @unique // "José", "Fabien", "Benoît", "Adrien"
  secret2FA          String    @map("secret_2fa") // Secret Google Authenticator unique
  password           String    // Hash bcrypt du mot de passe individuel
  mustChangePassword Boolean   @default(true) @map("must_change_password") // Forcer changement au premier login
  passwordChangedAt  DateTime? @map("password_changed_at") // Date du dernier changement
  isActive           Boolean   @default(true) @map("is_active")
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")

  @@map("admins")
}

// ═══════════════════════════════════════════════════════════
// ÉVÉNEMENTS (AE6, AE7, etc.)
// ═══════════════════════════════════════════════════════════

enum EventStatus {
  DRAFT       // Brouillon (non visible publiquement)
  OPEN        // Ouvert aux inscriptions
  CLOSED      // Fermé (événement passé ou complet)
  ARCHIVED    // Archivé (ancien événement)
}

model Event {
  id              String      @id @default(uuid())
  name            String      // "Anjou Explore #7"
  slug            String      @unique // "ae7" (pour URL)
  description     String?     @db.Text
  date            DateTime    // Date de l'événement
  status          EventStatus @default(DRAFT)
  paymentEnabled  Boolean     @default(false) @map("payment_enabled")

  // Gestion des inscriptions
  registrationDeadline      DateTime? @map("registration_deadline") // Date limite auto-close
  registrationOpenOverride  Boolean?  @map("registration_open_override") // true = forcer ouvert, false = forcer fermé, null = auto

  // Métadonnées
  location        String?     // "Domaine de Nerleux"
  partnerLogo     String?     @map("partner_logo") // URL ou chemin vers logo partenaire

  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  // Relations
  activities      Activity[]
  reservations    Reservation[]

  @@map("events")
}

// ═══════════════════════════════════════════════════════════
// ACTIVITÉS (nouveau modèle - une activité par événement)
// ═══════════════════════════════════════════════════════════

model Activity {
  id              String   @id @default(uuid())
  eventId         String   @map("event_id")
  event           Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)

  name            String   // "rando papilles", "le défi"
  description     String?  @db.Text // Description optionnelle
  maxParticipants Int?     @map("max_participants") // Limite totale pour cette activité (tous tarifs confondus)

  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  pricing         EventPricing[]
  reservations    Reservation[]

  @@unique([eventId, name]) // Pas de doublon activité par événement
  @@index([eventId])
  @@map("activities")
}

// ═══════════════════════════════════════════════════════════
// TARIFICATION (renommé de "Formula")
// ═══════════════════════════════════════════════════════════

model EventPricing {
  id          String   @id @default(uuid())
  activityId  String   @map("activity_id")
  activity    Activity @relation(fields: [activityId], references: [id], onDelete: Cascade)

  priceType   String   @map("price_type") // "adulte", "enfant", "étudiant", etc.
  label       String   // "Adulte (+16 ans)"
  price       Decimal  @db.Decimal(10, 2)

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@unique([activityId, priceType]) // Pas de doublon type par activité
  @@index([activityId])
  @@map("event_pricing")
}

// ═══════════════════════════════════════════════════════════
// RÉSERVATIONS (Inscriptions aux événements)
// ═══════════════════════════════════════════════════════════

enum PaymentStatus {
  PENDING   // En attente de paiement
  PAID      // Payé
  FAILED    // Échec de paiement
  REFUNDED  // Remboursé
  CANCELLED // Annulé
}

model Reservation {
  id              String        @id @default(uuid())

  // Groupe de réservations (pour multi-activités)
  // Plusieurs réservations peuvent partager le même groupId si réservées ensemble
  groupId         String?       @map("group_id")

  eventId         String        @map("event_id")
  event           Event         @relation(fields: [eventId], references: [id])

  // Informations client
  nom             String
  prenom          String
  email           String
  telephone       String

  // Activité choisie
  activityId      String?       @map("activity_id")
  activity        Activity?     @relation(fields: [activityId], references: [id])
  activityName    String        @map("activity_name") // "rando papilles", "le défi" (legacy)

  // Participants (JSONB pour flexibilité)
  // Exemple: { "adulte": 2, "enfant": 1 }
  participants    Json

  // Montant et paiement
  amount          Decimal       @db.Decimal(10, 2)
  paymentStatus   PaymentStatus @default(PENDING) @map("payment_status")

  // SumUp IDs (DEPRECATED - utiliser PaymentTransaction)
  // Gardés pour compatibilité ascendante
  sumupCheckoutId String?       @map("sumup_checkout_id")
  sumupTransactionId String?    @map("sumup_transaction_id")

  paidAt          DateTime?     @map("paid_at")

  // Métadonnées
  notes           String?       @db.Text // Notes internes admin
  archived        Boolean       @default(false) // Archivage logique (soft delete)
  archivedAt      DateTime?     @map("archived_at")
  archivedBy      String?       @map("archived_by") // Nom de l'admin

  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  // Relations
  paymentTransactions PaymentTransaction[]

  @@index([eventId])
  @@index([activityId])
  @@index([email])
  @@index([paymentStatus])
  @@index([archived])
  @@index([groupId])
  @@map("reservations")
}

// ═══════════════════════════════════════════════════════════
// TRANSACTIONS DE PAIEMENT (Historique SumUp)
// ═══════════════════════════════════════════════════════════

enum TransactionStatus {
  INITIATED    // Transaction initialisée (checkout créé)
  PENDING      // En attente de paiement
  COMPLETED    // Paiement réussi
  FAILED       // Paiement échoué
  EXPIRED      // Checkout expiré
  CANCELLED    // Annulé par l'utilisateur
}

model PaymentTransaction {
  id              String            @id @default(uuid())
  reservationId   String            @map("reservation_id")
  reservation     Reservation       @relation(fields: [reservationId], references: [id], onDelete: Cascade)

  // IDs SumUp
  checkoutId      String            @map("checkout_id") // ID du checkout SumUp
  transactionId   String?           @map("transaction_id") // ID de la transaction (si paiement effectué)

  // Montant
  amount          Decimal           @db.Decimal(10, 2)
  currency        String            @default("EUR")

  // Statut
  status          TransactionStatus @default(INITIATED)

  // Métadonnées SumUp
  sumupResponse   Json?             @map("sumup_response") // Réponse complète de l'API SumUp
  checkoutUrl     String?           @map("checkout_url") // URL de paiement

  // Dates
  initiatedAt     DateTime          @default(now()) @map("initiated_at")
  completedAt     DateTime?         @map("completed_at")
  expiredAt       DateTime?         @map("expired_at")

  // Métadonnées
  notes           String?           @db.Text
  createdAt       DateTime          @default(now()) @map("created_at")
  updatedAt       DateTime          @updatedAt @map("updated_at")

  @@index([reservationId])
  @@index([checkoutId])
  @@index([transactionId])
  @@index([status])
  @@map("payment_transactions")
}

// ═══════════════════════════════════════════════════════════
// DEMANDES DE CONTACT (Formulaire général)
// ═══════════════════════════════════════════════════════════

enum ContactStatus {
  NEW       // Nouveau (non traité)
  PROCESSED // Traité
  ARCHIVED  // Archivé
}

model ContactRequest {
  id            String        @id @default(uuid())

  // Informations de contact
  nom           String
  prenom        String?
  email         String
  telephone     String
  message       String        @db.Text

  // Si demande de réservation aventure (formulaire-groupe)
  isBooking     Boolean       @default(false) @map("is_booking")
  bookingData   Json?         @map("booking_data") // { participants, durée, formule }

  // Gestion admin
  status        ContactStatus @default(NEW)
  processedBy   String?       @map("processed_by") // Nom de l'admin qui a traité
  processedAt   DateTime?     @map("processed_at")

  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  @@index([status])
  @@index([createdAt])
  @@map("contact_requests")
}

// ═══════════════════════════════════════════════════════════
// SESSIONS (pour JWT tokens)
// ═══════════════════════════════════════════════════════════

model Session {
  id        String   @id @default(uuid())
  adminName String   @map("admin_name") // Référence au nom de l'admin
  token     String   @unique // JWT token
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  @@index([token])
  @@index([expiresAt])
  @@map("sessions")
}
