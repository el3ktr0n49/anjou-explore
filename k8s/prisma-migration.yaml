apiVersion: batch/v1
kind: Job
metadata:
  name: prisma-migrate-job
  namespace: anjouexplore
  labels:
    app: prisma-migrate
    component: database-migration
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      restartPolicy: Never
      imagePullSecrets:
        - name: harbor-registry
      containers:
        - name: migrate
          image: harbor.ratons.ovh/anjouexplore/anjouexplore:latest
          command:
            - /bin/sh
            - -c
            - |
              # V√©rifier que DATABASE_URL est d√©fini
              if [ -z "$DATABASE_URL" ]; then
                echo "‚ùå ERROR: DATABASE_URL is not set!"
                exit 1
              fi

              # Attendre que PostgreSQL soit pr√™t (retry 30 fois avec 2s d'intervalle = 1min max)
              echo "‚è≥ Waiting for database to be ready..."
              for i in $(seq 1 30); do
                if bun run -e "import{prisma}from'./src/lib/db/client';await prisma.\$connect();await prisma.\$disconnect()" 2>/dev/null; then
                  echo "‚úÖ Database ready!"
                  break
                fi
                [ $i -eq 30 ] && { echo "‚ùå Database not ready after 30 attempts"; exit 1; }
                sleep 2
              done

              # Le script init-db.ts g√®re :
              # - V√©rification si DB vide (premier d√©ploiement ou non)
              # - Application des migrations Prisma si n√©cessaires
              # - Seed des admins si premi√®re installation
              # Note: prisma migrate deploy est idempotent (ne fait rien si d√©j√† √† jour)
              echo "üîÑ Running database initialization..."
              bun run scripts/init-db.ts
          resources:
            requests:
              cpu: 250m
              memory: 512Mi
            limits:
              cpu: "1"
              memory: 2Gi
          envFrom:
            - secretRef:
                name: anjouexplore-secret