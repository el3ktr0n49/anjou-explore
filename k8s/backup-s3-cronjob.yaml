apiVersion: batch/v1
kind: CronJob
metadata:
  name: postgres-backup-s3
  namespace: anjouexplore
  labels:
    app: postgres
    component: backup-s3
spec:
  # Tous les dimanches Ã  3h du matin (heure UTC)
  schedule: "0 3 * * 0"
  successfulJobsHistoryLimit: 2
  failedJobsHistoryLimit: 2
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app: postgres
            component: backup-s3
        spec:
          restartPolicy: OnFailure
          containers:
            - name: s3-sync
              image: rclone/rclone:latest
              command:
                - /bin/sh
                - -c
                - |
                  set -e
                  echo "â˜ï¸ Starting S3 backup sync..."

                  # Configure rclone for S3
                  mkdir -p /root/.config/rclone
                  cat > /root/.config/rclone/rclone.conf <<EOF
                  [s3remote]
                  type = s3
                  provider = Other
                  endpoint = ${S3_ENDPOINT}
                  access_key_id = ${S3_ACCESS_KEY_ID}
                  secret_access_key = ${S3_SECRET_ACCESS_KEY}
                  region = ${S3_REGION}
                  acl = private
                  EOF

                  # Sync backups to S3
                  echo "ðŸ“¤ Uploading backups to S3..."
                  rclone sync /backups s3remote:${S3_BUCKET}/postgres-backups \
                    --progress \
                    --transfers 4 \
                    --checkers 8 \
                    --log-level INFO

                  # Cleanup old backups on S3 (keep 12 weeks = ~3 months)
                  echo "ðŸ§¹ Cleaning old S3 backups (keeping last 12 weeks)..."
                  rclone delete s3remote:${S3_BUCKET}/postgres-backups \
                    --min-age 84d \
                    --rmdirs

                  # Stats
                  echo "ðŸ“Š S3 Backup statistics:"
                  rclone size s3remote:${S3_BUCKET}/postgres-backups

                  echo "âœ… S3 backup sync completed successfully!"
              env:
                - name: S3_ENDPOINT
                  valueFrom:
                    secretKeyRef:
                      name: s3-backup-secret
                      key: S3_ENDPOINT
                - name: S3_BUCKET
                  valueFrom:
                    secretKeyRef:
                      name: s3-backup-secret
                      key: S3_BUCKET
                - name: S3_ACCESS_KEY_ID
                  valueFrom:
                    secretKeyRef:
                      name: s3-backup-secret
                      key: S3_ACCESS_KEY_ID
                - name: S3_SECRET_ACCESS_KEY
                  valueFrom:
                    secretKeyRef:
                      name: s3-backup-secret
                      key: S3_SECRET_ACCESS_KEY
                - name: S3_REGION
                  valueFrom:
                    secretKeyRef:
                      name: s3-backup-secret
                      key: S3_REGION
              volumeMounts:
                - name: backup-storage
                  mountPath: /backups
                  readOnly: true
              resources:
                requests:
                  memory: "128Mi"
                  cpu: "100m"
                limits:
                  memory: "256Mi"
                  cpu: "500m"
          volumes:
            - name: backup-storage
              persistentVolumeClaim:
                claimName: backup-pvc
